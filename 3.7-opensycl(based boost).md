# OpenSYCL(for ROCm)

## Dependencies: Boost C++ libs, cmake, ROCm, Python3(conda)

### Boost C++ libs: [linux-version-1.83.0](https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.tar.gz)

on Ubuntu 20.04(2023.9.16 latest compile passed)

on ks supercomputer center environment compile passed, list modules:

error on NFS of SUMA g++ version 8.3.1 by default, use g++ 9.4.0 instead.

````bash
1) apps/anaconda3/5.2.0        2) compiler/devtoolset/7.3.1
3) compiler/cmake/3.22.0-rc1   4) compiler/rocm/dtk-23.04
5) mpi/hpcx/2.6.0/gcc-7.3.1
````

### Build OpenSYCL with ROCm
- #### compile for AMD rocm-5.4.1(clang15)--compiling test successfully
  ````bash
  $ export CC=clang # clang of .../rocm/llvm/bin or add -DCMAKE_C_COMPILER=clang
  $ export CXX=clang++ # clang++ of .../rocm/llvm/bin or add -DCMAKE_CXX_COMPILER=clang++
  $ cd build && rm -rf ./* && cmake -DCMAKE_INSTALL_PREFIX=/home/ljl/Apps/OpenSYCL -DROCM_PATH=/opt/rocm -DWITH_ROCM_BACKEND=ON -DWITH_CUDA_BACKEND=OFF -DHIPSYCL_NO_DEVICE_MANGLER=ON -DWITH_ACCELERATED_CPU=OFF -DWITH_SSCP_COMPILER=OFF .. && make -j8 install
  ````


- #### compile for ks supercomputer center dtk-23.04--need higher version glib
  ````bash
  $ export CC=clang # clang of .../rocm/llvm/bin or add -DCMAKE_C_COMPILER=clang
  $ export CXX=clang++ # clang++ of .../rocm/llvm/bin or add -DCMAKE_CXX_COMPILER=clang++
  $ cd build && rm -rf ./* && cmake -DCMAKE_INSTALL_PREFIX=/public/home/ljlnwpu/OpenSYCL/OpenSYCL -DROCM_PATH=/public/software/compiler/rocm/dtk-23.04 -DWITH_ROCM_BACKEND=ON -DWITH_CUDA_BACKEND=OFF -DHIPSYCL_NO_DEVICE_MANGLER=ON -DWITH_ACCELERATED_CPU=OFF -DWITH_SSCP_COMPILER=OFF .. && make -j8 install
  ````
  - ##### add cmake option -DWITH_SSCP_COMPILER=OFF for preventing "/usr/bin/ld: can't find -lLLVM"
  - ##### capture a compile bug of OpenSYCL because aligned_alloc() is pulled into std namespace after C++17:(this is for OMP)

  ````bash
  OpenSYCL-build/src/runtime/omp/omp_allocator.cpp:57:10: error: no member named 'aligned_alloc' in namespace 'std'; did you mean simply 'aligned_alloc'?
  mv "return std::aligned_alloc(min_alignment, size_bytes);" -> "return aligned_alloc(min_alignment, size_bytes)"
  ````


- #### compile for suma dtk-23.04(clang15), dtk-22.10(clang14) not compile pass--need higher version compiler and suitable cxx lib
  ````bash
  $ export CC=clang # clang of .../rocm/llvm/bin or add -DCMAKE_C_COMPILER=clang
  $ export CXX=clang++ # clang++ of .../rocm/llvm/bin or add -DCMAKE_CXX_COMPILER=clang++
  $ cd build && rm -rf ./* && cmake -DCMAKE_INSTALL_PREFIX=/home/ljl/Apps/OpenSYCL -DROCM_PATH=/opt/rocm -DWITH_ROCM_BACKEND=ON -DWITH_CUDA_BACKEND=OFF -DHIPSYCL_NO_DEVICE_MANGLER=ON -DWITH_ACCELERATED_CPU=OFF -DWITH_SSCP_COMPILER=OFF .. && make -j8 install
  ````
  - ##### without cmake option -DWITH_ACCELERATED_CPU=OFF compile pass, running std::bad_alloc(), seems related to bad g++
